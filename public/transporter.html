<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ubacarona - Panel de Conductor</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: Arial, sans-serif;
    }

    body {
      background-color: #ffffff;
      color: #000000;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .container {
      width: 90vw;
      height: 90vh;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      border: 2px solid black;
      padding: 2vh;
      border-radius: 1vh;
      overflow: hidden;
    }

    #registration,
    #assignment {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 2vh;
    }

    input,
    textarea {
      padding: 1vh;
      font-size: 1.8vh;
      width: 100%;
    }

    button {
      padding: 1.5vh;
      font-size: 2vh;
      cursor: pointer;
      background-color: #000;
      color: #fff;
      border: none;
      border-radius: 0.5vh;
    }

    h2, h3 {
      margin-bottom: 1vh;
    }

    #selectedPassengerList,
    #notSelectedPassengerList {
      flex: 1;
      overflow-y: auto;
      border: 1px solid #000;
      padding: 1vh;
      margin-bottom: 1vh;
    }

    label {
      display: block;
      margin-bottom: 0.5vh;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 1vh;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="registration">
      <h2>Registro de Conductor</h2>
      <input id="driverName" placeholder="Ingresa tu nombre" />
      <button onclick="registerOrLoginDriver()">Entrar</button>
    </div>

    <div id="assignment" style="display: none;">
      <h2>Bienvenido, <span id="driverWelcome"></span></h2>

      <h3>Pasajeros asignados</h3>
      <div id="selectedPassengerList"></div>

      <h3>Pasajeros no asignados</h3>
      <div id="notSelectedPassengerList"></div>

      <button id="toggleTravelBtn" onclick="toggleTravelDetails()">Editar Detalles de Viaje</button>

      <form id="travelDetailsForm" style="display: none;">
        <input id="travelTime" placeholder="Hora del viaje" />
        <input id="travelLocation" placeholder="Lugar del viaje" />
        <textarea id="travelComments" placeholder="Comentarios"></textarea>
        <button type="button" onclick="saveTravelDetails()">Guardar Detalles</button>
      </form>

      <button onclick="logout()">Cerrar sesi√≥n</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import {
      getDatabase, ref, get, set, update
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD8rSlUYQivypC11w1B4Txy7W7bW81RbP8",
      authDomain: "ubacarona.firebaseapp.com",
      databaseURL: "https://ubacarona-default-rtdb.firebaseio.com",
      projectId: "ubacarona",
      storageBucket: "ubacarona.firebasestorage.app",
      messagingSenderId: "1032392073098",
      appId: "1:1032392073098:web:f40d193f6e867fe0d9f273"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let driverName = "";

    window.addEventListener("DOMContentLoaded", async () => {
      const saved = localStorage.getItem("driverName");
      if (saved) {
        driverName = saved;
        const exists = await checkDriverExists(saved);
        if (exists) showAssignmentSection();
        else localStorage.removeItem("driverName");
      }
    });

    async function checkDriverExists(name) {
      const snapshot = await get(ref(db, "drivers"));
      const drivers = snapshot.val() || {};
      return Object.values(drivers).some(d => d.name === name);
    }

    window.registerOrLoginDriver = async () => {
      driverName = document.getElementById("driverName").value.trim();
      if (!driverName) return alert("Por favor ingresa tu nombre.");
      const exists = await checkDriverExists(driverName);
      if (exists) {
        localStorage.setItem("driverName", driverName);
        showAssignmentSection();
      } else {
        const id = crypto.randomUUID();
        await set(ref(db, `drivers/${id}`), {
          name: driverName,
          passengers: []
        });
        localStorage.setItem("driverName", driverName);
        showAssignmentSection();
      }
    };

    async function showAssignmentSection() {
      document.getElementById("registration").style.display = "none";
      document.getElementById("assignment").style.display = "flex";
      document.getElementById("driverWelcome").textContent = driverName;
      loadPassengers();
    }

    async function loadPassengers() {
      const snapshot = await get(ref(db));
      const data = snapshot.val() || {};
      const selectedList = document.getElementById("selectedPassengerList");
      const notSelectedList = document.getElementById("notSelectedPassengerList");
      selectedList.innerHTML = "";
      notSelectedList.innerHTML = "";

      const driverEntry = Object.entries(data.drivers || {}).find(([id, d]) => d.name === driverName);
      const assignedNames = driverEntry ? driverEntry[1].passengers || [] : [];

      Object.entries(data.passengers || {}).forEach(([id, p]) => {
        const isAssigned = p.driver === driverName;
        const div = document.createElement("div");
        div.innerHTML = `<label><input type="checkbox" ${isAssigned ? "checked" : ""}> ${p.name}</label>`;
        div.querySelector("input").addEventListener("change", async e => {
          const assign = e.target.checked;
          await update(ref(db, `passengers/${id}`), {
            assigned: assign,
            driver: assign ? driverName : null
          });

          const driverRef = ref(db, `drivers/${driverEntry[0]}`);
          const updatedPassengers = assign
            ? [...assignedNames, p.name]
            : assignedNames.filter(n => n !== p.name);

          await update(driverRef, { passengers: updatedPassengers });
          loadPassengers();
        });

        const container = isAssigned ? selectedList : notSelectedList;
        container.appendChild(div);
      });
    }

    window.saveTravelDetails = async () => {
      const time = document.getElementById("travelTime").value.trim();
      const location = document.getElementById("travelLocation").value.trim();
      const comments = document.getElementById("travelComments").value.trim();

      const snap = await get(ref(db));
      const all = snap.val() || {};
      const myPassengers = Object.entries(all.passengers || {}).filter(([id, p]) => p.driver === driverName);
      for (const [id] of myPassengers) {
        await update(ref(db, `passengers/${id}`), {
          time,
          location,
          comments
        });
      }
      alert("Detalles de viaje guardados para todos los pasajeros.");
    };

    window.toggleTravelDetails = () => {
      const form = document.getElementById("travelDetailsForm");
      const button = document.getElementById("toggleTravelBtn");
      if (form.style.display === "none") {
        form.style.display = "flex";
        button.textContent = "Cerrar Detalles de Viaje";
      } else {
        form.style.display = "none";
        button.textContent = "Editar Detalles de Viaje";
      }
    };

    window.logout = () => {
      localStorage.removeItem("driverName");
      location.reload();
    };
  </script>
</body>
</html>
