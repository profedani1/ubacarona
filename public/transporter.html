<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel del Conductor</title>
  <style>
    /* (styles unchanged) */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }

    html, body {
      height: 100vh;
      background: linear-gradient(145deg, black, #2a2e38);
      color: #f5f5f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: start;
      padding: 2vh;
    }

    #registration, #assignment {
      width: 90vw;
      max-width: 600px;
      margin-bottom: 3vh;
      background-color: #2e3440;
      border: 1px solid #444;
      border-radius: 1vh;
      padding: 2vh;
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.15);
    }

    h2, h3 {
      font-size: 2.2vh;
      margin-bottom: 1vh;
      color: #00bcd4;
    }

    h4 {
      font-size: 1.8vh;
      color: #aaa;
      margin-bottom: 0.5vh;
    }

    .section {
      margin: 1.5vh 0;
      padding: 2vh;
      border: 1px solid #555;
      border-radius: 1vh;
      background: #3a3f4b;
      box-shadow: 0 0 6px rgba(255, 255, 255, 0.05);
    }

    .section input[type="text"] {
      width: 100%;
      margin: 1vh 0;
      padding: 1.2vh;
      border-radius: 0.5vh;
      background: #1e1e1e;
      border: 1px solid #555;
      color: #f5f5f5;
    }

    .section input[type="text"]::placeholder {
      color: #888;
    }

    .passenger-details {
      margin-left: 2vh;
      font-size: 1.5vh;
      color: #bbb;
    }

    button {
      margin-top: 2vh;
      padding: 1.5vh 2vh;
      background: linear-gradient(to right, #00bcd4, #008cba);
      color: black;
      border: none;
      border-radius: 1vh;
      font-weight: bold;
      font-size: 2vh;
      cursor: pointer;
      transition: transform 0.2s ease, background 0.3s;
    }

    button:hover {
      transform: scale(1.05);
      background: black;
      color: white;
    }

    .subsection {
      margin-top: 2vh;
      padding: 1.5vh;
      border: 1px dashed #777;
      border-radius: 1vh;
      background: #2b313c;
    }

    #travelDetailsForm {
      display: none;
    }
  </style>
</head>
<body>
  <button class="title-button" onclick="loadInnerActivity('index.html')">panel</button> 
  <div id="registration">
    <h2>Ingreso del Conductor</h2>
    <input type="text" id="driverName" placeholder="Ingresa tu nombre" />
    <button onclick="registerOrLoginDriver()">Registrarse / Iniciar sesi√≥n</button>
  </div>

  <div id="assignment" style="display: none;">
    <h2>¬°Bienvenido, <span id="driverWelcome"></span>!</h2>

    <div class="section">
      <h3>Asignaci√≥n de Pasajeros</h3>
      <div class="subsection">
        <h4>‚úÖ Pasajeros Seleccionados</h4>
        <div id="selectedPassengerList"></div>
      </div>
      <div class="subsection">
        <h4>‚ùå Pasajeros No Seleccionados</h4>
        <div id="notSelectedPassengerList"></div>
      </div>
    </div>

    <div class="section">
      <h3>Detalles del Viaje (aplica a todos los pasajeros)</h3>
      <button id="toggleTravelBtn" onclick="toggleTravelDetails()">Editar Detalles del Viaje</button>
      <div id="travelDetailsForm">
        <label>Hora: <input type="text" id="travelTime" placeholder="ej. 14:30"></label><br>
        <label>Ubicaci√≥n: <input type="text" id="travelLocation" placeholder="ej. Calle Principal 123"></label><br>
        <label>Comentarios: <input type="text" id="travelComments" placeholder="ej. Estar listo a tiempo"></label><br>
        <button onclick="saveTravelDetails()">Guardar Detalles del Viaje</button>
      </div>
    </div>

    <button onclick="logout()">Cerrar sesi√≥n</button>
    <button onclick="eraseAccount()">Eliminar cuenta</button>
  </div>

  <script>
    let driverName = "";

    window.onload = () => {
      const savedDriver = localStorage.getItem("driverName");
      if (savedDriver) {
        driverName = savedDriver;
        checkDriverExists(savedDriver).then(exists => {
          if (exists) {
            showAssignmentSection();
          } else {
            localStorage.removeItem("driverName");
          }
        });
      }
    };

    function registerOrLoginDriver() {
      driverName = document.getElementById("driverName").value.trim();
      if (!driverName) {
        alert("Por favor ingresa tu nombre.");
        return;
      }

      checkDriverExists(driverName).then(exists => {
        if (exists) {
          localStorage.setItem("driverName", driverName);
          showAssignmentSection();
        } else {
          fetch("/api/drivers", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name: driverName })
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              localStorage.setItem("driverName", driverName);
              showAssignmentSection();
            } else {
              alert("No se pudo registrar al conductor.");
            }
          });
        }
      });
    }

    async function checkDriverExists(name) {
      const response = await fetch("/api/data");
      const data = await response.json();
      return data.drivers.some(driver => driver.name === name);
    }

    function showAssignmentSection() {
      document.getElementById("registration").style.display = "none";
      document.getElementById("assignment").style.display = "block";
      document.getElementById("driverWelcome").textContent = driverName;
      loadPassengers();
    }

    function loadPassengers() {
      fetch("/api/data")
        .then(res => res.json())
        .then(async data => {
          const selectedList = document.getElementById("selectedPassengerList");
          const notSelectedList = document.getElementById("notSelectedPassengerList");
          selectedList.innerHTML = "";
          notSelectedList.innerHTML = "";

          const driver = data.drivers.find(d => d.name === driverName);
          const assignedPassengers = driver ? driver.passengers : [];

          const selectedPassengers = data.passengers
            .filter(p => p.driver === driverName)
            .map(p => ({ name: p.name, assigned: true }));

          const notSelectedPassengers = data.passengers
            .filter(p => !p.assigned)
            .map(p => ({ name: p.name, assigned: false }));

          for (const p of selectedPassengers) {
            await addPassengerToList(p, selectedList, true);
          }

          for (const p of notSelectedPassengers) {
            await addPassengerToList(p, notSelectedList, false);
          }
        });
    }

    async function addPassengerToList(passenger, container, isAssigned) {
      const passengerDiv = document.createElement("div");
      passengerDiv.className = "passenger-item";

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.value = passenger.name;
      checkbox.checked = isAssigned;

      checkbox.addEventListener("change", () => {
        const newContainer = isAssigned 
          ? document.getElementById("notSelectedPassengerList") 
          : document.getElementById("selectedPassengerList");

        passengerDiv.remove();
        newContainer.appendChild(passengerDiv);
        checkbox.checked = !isAssigned;
        movePassenger(passenger.name, !isAssigned);
      });

      const label = document.createElement("label");
      label.textContent = passenger.name;
      label.prepend(checkbox);

      passengerDiv.appendChild(label);

      const detailsDiv = document.createElement("div");
      detailsDiv.className = "passenger-details";

      try {
        const res = await fetch(`/api/passengers/${encodeURIComponent(passenger.name)}/personal`);
        if (res.ok) {
          const info = await res.json();
          let detailsHTML = "";

          if (info.numPeople) detailsHTML += `<div>üë• ${info.numPeople} personas</div>`;
          if (info.meetLocation) detailsHTML += `<div>üìç ${info.meetLocation}</div>`;
          if (info.meetTime) detailsHTML += `<div>‚è∞ ${info.meetTime}</div>`;

          if (detailsHTML) {
            detailsDiv.innerHTML = detailsHTML;
            passengerDiv.appendChild(detailsDiv);
          }
        }
      } catch (err) {
        console.error("Error al obtener la informaci√≥n personal:", err);
      }

      container.appendChild(passengerDiv);
    }

    function movePassenger(passengerName, assign) {
      fetch(`/api/drivers/${encodeURIComponent(driverName)}/passengers`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ passengerName, assign })
      })
      .then(res => res.json())
      .then(data => {
        if (!data.success) {
          alert("No se pudo actualizar la asignaci√≥n del pasajero.");
        }
      });
    }

    function toggleTravelDetails() {
      const form = document.getElementById("travelDetailsForm");
      const button = document.getElementById("toggleTravelBtn");
      if (form.style.display === "none") {
        form.style.display = "block";
        button.textContent = "Cerrar Detalles del Viaje";
      } else {
        form.style.display = "none";
        button.textContent = "Editar Detalles del Viaje";
      }
    }

    function saveTravelDetails() {
      const time = document.getElementById("travelTime").value.trim();
      const location = document.getElementById("travelLocation").value.trim();
      const comments = document.getElementById("travelComments").value.trim();

      fetch(`/api/drivers/${encodeURIComponent(driverName)}/travel`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ time, location, comments })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert("Detalles del viaje guardados para todos los pasajeros.");
        } else {
          alert("No se pudieron guardar los detalles del viaje.");
        }
      });
    }

    function logout() {
      localStorage.removeItem("driverName");
      location.reload();
    }

    function eraseAccount() {
      if (!confirm("¬øEst√°s seguro de que quieres eliminar tu cuenta? Esto eliminar√° todas tus asignaciones.")) {
        return;
      }

      fetch(`/api/drivers/${encodeURIComponent(driverName)}`, {
        method: "DELETE"
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert("Tu cuenta ha sido eliminada.");
          localStorage.removeItem("driverName");
          location.reload();
        } else {
          alert("Error: " + data.message);
        }
      });
    }

    function loadInnerActivity(activityUrl) {
      window.location.href = activityUrl;
    }
  </script>
</body>
</html>
